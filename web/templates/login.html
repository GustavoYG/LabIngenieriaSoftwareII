<title>Iniciar Sesión | Traffic Pulse</title>

<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
  crossorigin="anonymous" />
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
{% load static %}

<div class="container-fluid m-0 row bg-primary" style="min-height: 100%">
  <main class="form-signin row col-md-6 py-4 m-auto bg-white rounded">
    <div class="container-fluid col col-md-6">
      <img
        src="{% static 'images/user-icon.webp' %}"
        class="img-fluid w-100 mx-auto d-block mb-4"
        style="max-width: 200px"
        alt="user-icon" />
      <h4 class="text-center mb-4 text-muted">Bienvenido de vuelta</h4>
    </div>

    <!-- Mensajes de Django -->
    {% if messages %} {% for message in messages %}
    <div
      class="alert alert-{{ message.tags }} alert-dismissible fade show"
      role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %} {% endif %}

    <form method="post" id="login-form" novalidate>
      {% csrf_token %}

      <div class="form-floating mb-3">
        {{ form.username }}
        <label for="username">Usuario</label>
        {% if form.username.errors %}
        <div class="invalid-feedback d-block">{{ form.username.errors.0 }}</div>
        {% endif %}
      </div>

      <!-- Contraseña -->
      <div class="position-relative mb-3">
        <div class="form-floating position-relative col-11 d-flex w-100">
          {{ form.password }}
          <label for="password">Contraseña</label>
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm toggle-password col-1 border-secondary-subtle">
            <i class="bi bi-eye toggle-icon"></i>
          </button>
        </div>
        {% if form.password.errors %}
        <div class="invalid-feedback d-block">{{ form.password.errors.0 }}</div>
        {% endif %}
      </div>

      <!-- Mostrar errores generales del formulario -->
      {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for error in form.non_field_errors %}
        <div>{{ error }}</div>
        {% endfor %}
      </div>
      {% endif %}

      <p class="text-muted text-end pe-4" style="font-size: 0.8em">
        ¿No tienes una cuenta?
        <a href="{% url 'register' %}" class="link-offset-1-hover"
          >Crear cuenta</a
        >
      </p>

      <div class="d-flex justify-content-end pe-4">
        <button type="submit" class="btn btn-secondary">Iniciar Sesión</button>
      </div>
    </form>
  </main>
</div>

<script>
  const form = document.getElementById("login-form");
  const username = document.getElementById("username");
  const password = document.getElementById("password");
  const toggleButton = document.querySelector(".toggle-password");
  const toggleIcon = document.querySelector(".toggle-icon");

  // Mostrar/ocultar contraseña
  if (toggleButton) {
    toggleButton.addEventListener("click", () => {
      const type =
        password.getAttribute("type") === "password" ? "text" : "password";
      password.setAttribute("type", type);
      toggleIcon.classList.toggle("bi-eye");
      toggleIcon.classList.toggle("bi-eye-slash");
    });
  }

  // Validación al enviar el formulario
  form.addEventListener("submit", function (e) {
    let valid = true;

    // Limpiar clases anteriores
    [username, password].forEach((input) => {
      input.classList.remove("is-invalid");
    });

    // Validar usuario
    if (username.value.trim() === "") {
      username.classList.add("is-invalid");
      valid = false;
    }

    // Validar contraseña
    if (password.value.trim() === "") {
      password.classList.add("is-invalid");
      valid = false;
    }

    // Cancelar envío si hay errores
    if (!valid) {
      e.preventDefault();
    }
  });
</script>
