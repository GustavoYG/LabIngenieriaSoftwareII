<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Alertas y Notificaciones</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .result { margin-top: 20px; padding: 15px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .section { margin-bottom: 40px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .notificacion { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .notificacion.emergencia { border-left: 4px solid #dc3545; }
        .notificacion.trafico { border-left: 4px solid #fd7e14; }
        .notificacion.informativa { border-left: 4px solid #17a2b8; }
        .notificacion.zona_peligrosa { border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test de Alertas y Notificaciones</h1>
        
        <!-- Sección 1: Crear Alerta -->
        <div class="section">
            <h2>1. Crear Alerta (Tarea 1)</h2>
            <form id="form-crear-alerta">
                <div class="form-group">
                    <label for="titulo">Título:</label>
                    <input type="text" id="titulo" name="titulo" required>
                </div>
                
                <div class="form-group">
                    <label for="mensaje">Mensaje:</label>
                    <textarea id="mensaje" name="mensaje" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="tipo_alerta">Tipo de Alerta:</label>
                    <select id="tipo_alerta" name="tipo_alerta" required>
                        <option value="">Seleccionar...</option>
                        <option value="emergencia">Emergencia</option>
                        <option value="trafico">Tráfico</option>
                        <option value="informativa">Informativa</option>
                        <option value="zona_peligrosa">Zona Peligrosa</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="tiene_ubicacion" name="tiene_ubicacion"> 
                        Incluir ubicación específica
                    </label>
                </div>
                
                <div id="ubicacion-fields" style="display: none;">
                    <div class="form-group">
                        <label for="latitud">Latitud:</label>
                        <input type="number" id="latitud" name="latitud" step="0.0000001">
                    </div>
                    
                    <div class="form-group">
                        <label for="longitud">Longitud:</label>
                        <input type="number" id="longitud" name="longitud" step="0.0000001">
                    </div>
                    
                    <div class="form-group">
                        <label for="radio_cobertura">Radio de Cobertura (metros):</label>
                        <input type="number" id="radio_cobertura" name="radio_cobertura" value="1000">
                    </div>
                </div>
                
                <button type="submit">Crear Alerta</button>
            </form>
            
            <div id="resultado-alerta" class="result" style="display: none;"></div>
        </div>
        
        <!-- Sección 2: Simular Ubicación Usuario -->
        <div class="section">
            <h2>2. Procesar Ubicación Usuario (Tarea 2)</h2>
            <form id="form-ubicacion">
                <div class="form-group">
                    <label for="usuario_id">ID Usuario:</label>
                    <input type="number" id="usuario_id" name="usuario_id" value="1" required>
                </div>
                
                <div class="form-group">
                    <label for="lat_usuario">Latitud:</label>
                    <input type="number" id="lat_usuario" name="latitud" step="0.0000001" value="-16.4090" required>
                </div>
                
                <div class="form-group">
                    <label for="lng_usuario">Longitud:</label>
                    <input type="number" id="lng_usuario" name="longitud" step="0.0000001" value="-71.5375" required>
                </div>
                
                <button type="submit">Procesar Ubicación</button>
            </form>
            
            <div id="resultado-ubicacion" class="result" style="display: none;"></div>
        </div>
        
        <!-- Sección 3: Configurar Notificaciones -->
        <div class="section">
            <h2>3. Configurar Notificaciones Usuario</h2>
            <form id="form-configuracion">
                <div class="form-group">
                    <label for="usuario_config_id">ID Usuario:</label>
                    <input type="number" id="usuario_config_id" name="usuario_id" value="1" required>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="notificaciones_activas" name="notificaciones_trafico_activas" checked> 
                        Notificaciones de tráfico activas
                    </label>
                </div>
                
                <div class="form-group">
                    <label for="radio_notif">Radio de Notificaciones (metros):</label>
                    <input type="number" id="radio_notif" name="radio_notificaciones" value="1000">
                </div>
                
                <div class="form-group">
                    <label for="tipos_incidentes">Tipos de Incidentes de Interés:</label>
                    <div>
                        <label><input type="checkbox" value="congestion" checked> Congestión</label>
                        <label><input type="checkbox" value="accident" checked> Accidente</label>
                        <label><input type="checkbox" value="road_closure" checked> Cierre de Vía</label>
                        <label><input type="checkbox" value="construction" checked> Construcción</label>
                    </div>
                </div>
                
                <button type="submit">Guardar Configuración</button>
            </form>
            
            <div id="resultado-configuracion" class="result" style="display: none;"></div>
        </div>

        <!-- Sección 4: Ver Notificaciones -->
        <div class="section">
            <h2>4. Ver Notificaciones Usuario</h2>
            <div class="form-group">
                <label for="usuario_notif_id">ID Usuario:</label>
                <input type="number" id="usuario_notif_id" value="1">
                <button onclick="cargarNotificaciones()">Cargar Notificaciones</button>
            </div>
            
            <div id="notificaciones-container">
                <p>Haga clic en "Cargar Notificaciones" para ver las notificaciones del usuario.</p>
            </div>
        </div>

        <!-- Sección 5: Simulación de Datos -->
        <div class="section">
            <h2>5. Simulación de Datos de Prueba</h2>
            <p>Use estos datos para probar el sistema:</p>
            <button onclick="llenarDatosEjemplo()">Llenar Datos de Ejemplo</button>
            <button onclick="simularTrafico()">Simular Tráfico Cercano</button>
            
            <div id="datos-ejemplo" style="margin-top: 10px;">
                <h4>Coordenadas de Ejemplo (Arequipa, Perú):</h4>
                <ul>
                    <li>Plaza de Armas: -16.3988, -71.5369</li>
                    <li>Cerro Colorado: -16.4090, -71.5375</li>
                    <li>Cayma: -16.3658, -71.5203</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Variables para simular datos
        let alertasCreadas = [];
        let notificacionesSimuladas = [];

        // Mostrar/ocultar campos de ubicación
        document.getElementById('tiene_ubicacion').addEventListener('change', function() {
            const ubicacionFields = document.getElementById('ubicacion-fields');
            ubicacionFields.style.display = this.checked ? 'block' : 'none';
        });

        // Manejar creación de alerta
        document.getElementById('form-crear-alerta').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                titulo: formData.get('titulo'),
                mensaje: formData.get('mensaje'),
                tipo_alerta: formData.get('tipo_alerta'),
                usuario_creador_id: 1
            };

            if (document.getElementById('tiene_ubicacion').checked) {
                data.ubicacion = [
                    parseFloat(formData.get('latitud')),
                    parseFloat(formData.get('longitud'))
                ];
                data.radio_cobertura = parseInt(formData.get('radio_cobertura'));
            }

            // Simular creación de alerta
            simularCrearAlerta(data);
        });

        // Manejar procesamiento de ubicación
        document.getElementById('form-ubicacion').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                usuario_id: parseInt(formData.get('usuario_id')),
                latitud: parseFloat(formData.get('latitud')),
                longitud: parseFloat(formData.get('longitud'))
            };

            simularProcesarUbicacion(data);
        });

        // Manejar configuración de notificaciones
        document.getElementById('form-configuracion').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const tiposIncidentes = Array.from(document.querySelectorAll('input[type="checkbox"][value]'))
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            const data = {
                usuario_id: parseInt(formData.get('usuario_id')),
                notificaciones_trafico_activas: document.getElementById('notificaciones_activas').checked,
                radio_notificaciones: parseInt(formData.get('radio_notificaciones')),
                tipos_incidentes_interes: tiposIncidentes
            };

            simularConfigurarNotificaciones(data);
        });

        // Funciones de simulación
        function simularCrearAlerta(data) {
            try {
                const alerta = {
                    alerta_id: Date.now(),
                    ...data,
                    fecha_creacion: new Date().toISOString(),
                    es_activa: true,
                    prioridad: calcularPrioridad(data.tipo_alerta)
                };

                alertasCreadas.push(alerta);
                
                // Simular envío de notificaciones
                if (data.ubicacion) {
                    simularNotificacionesPorUbicacion(alerta);
                } else {
                    simularNotificacionesMasivas(alerta);
                }

                mostrarResultado('resultado-alerta', 'success', 
                    `Alerta creada exitosamente. ID: ${alerta.alerta_id}`);
            } catch (error) {
                mostrarResultado('resultado-alerta', 'error', 
                    `Error al crear alerta: ${error.message}`);
            }
        }

        function simularProcesarUbicacion(data) {
            try {
                // Simular detección de tráfico cercano
                const traficoDetectado = Math.random() > 0.7; // 30% de probabilidad
                
                if (traficoDetectado) {
                    const tiposIncidente = ['congestion', 'accident', 'road_closure'];
                    const tipoRandom = tiposIncidente[Math.floor(Math.random() * tiposIncidente.length)];
                    
                    const notificacion = {
                        id: Date.now(),
                        usuario_id: data.usuario_id,
                        titulo: `Tráfico Detectado`,
                        mensaje: `${getTipoIncidenteNombre(tipoRandom)} detectado cerca de su ubicación`,
                        tipo: 'trafico_cercano',
                        fecha_envio: new Date().toISOString(),
                        es_leida: false,
                        prioridad: 3
                    };

                    notificacionesSimuladas.push(notificacion);
                    
                    mostrarResultado('resultado-ubicacion', 'success', 
                        `Ubicación procesada. Tráfico detectado: ${getTipoIncidenteNombre(tipoRandom)}`);
                } else {
                    mostrarResultado('resultado-ubicacion', 'success', 
                        'Ubicación procesada. No se detectó tráfico cercano.');
                }
            } catch (error) {
                mostrarResultado('resultado-ubicacion', 'error', 
                    `Error al procesar ubicación: ${error.message}`);
            }
        }

        function simularConfigurarNotificaciones(data) {
            try {
                // Simular guardado de configuración
                localStorage.setItem(`config_${data.usuario_id}`, JSON.stringify(data));
                
                mostrarResultado('resultado-configuracion', 'success', 
                    'Configuración guardada exitosamente');
            } catch (error) {
                mostrarResultado('resultado-configuracion', 'error', 
                    `Error al guardar configuración: ${error.message}`);
            }
        }

        function cargarNotificaciones() {
            const usuarioId = parseInt(document.getElementById('usuario_notif_id').value);
            const notificacionesUsuario = notificacionesSimuladas.filter(n => n.usuario_id === usuarioId);
            
            const container = document.getElementById('notificaciones-container');
            
            if (notificacionesUsuario.length === 0) {
                container.innerHTML = '<p>No hay notificaciones para este usuario.</p>';
                return;
            }

            let html = '<h4>Notificaciones:</h4>';
            notificacionesUsuario.forEach(notif => {
                html += `
                    <div class="notificacion ${notif.tipo}">
                        <strong>${notif.titulo}</strong><br>
                        ${notif.mensaje}<br>
                        <small>Fecha: ${new Date(notif.fecha_envio).toLocaleString()}</small>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function llenarDatosEjemplo() {
            document.getElementById('titulo').value = 'Accidente en Av. Ejercito';
            document.getElementById('mensaje').value = 'Accidente de tránsito reportado en Av. Ejercito con Jr. Puno. Evite la zona.';
            document.getElementById('tipo_alerta').value = 'trafico';
            document.getElementById('tiene_ubicacion').checked = true;
            document.getElementById('tiene_ubicacion').dispatchEvent(new Event('change'));
            document.getElementById('latitud').value = '-16.3988';
            document.getElementById('longitud').value = '-71.5369';
            document.getElementById('radio_cobertura').value = '500';
        }

        function simularTrafico() {
            const data = {
                usuario_id: 1,
                latitud: -16.3988,
                longitud: -71.5369
            };
            
            // Forzar detección de tráfico
            const tiposIncidente = ['congestion', 'accident', 'road_closure'];
            const tipoRandom = tiposIncidente[Math.floor(Math.random() * tiposIncidente.length)];
            
            const notificacion = {
                id: Date.now(),
                usuario_id: data.usuario_id,
                titulo: `Alerta de Tráfico`,
                mensaje: `${getTipoIncidenteNombre(tipoRandom)} reportado en Plaza de Armas`,
                tipo: 'trafico_cercano',
                fecha_envio: new Date().toISOString(),
                es_leida: false,
                prioridad: 4
            };

            notificacionesSimuladas.push(notificacion);
            
            mostrarResultado('resultado-ubicacion', 'success', 
                `Tráfico simulado: ${getTipoIncidenteNombre(tipoRandom)} en Plaza de Armas`);
        }

        // Funciones auxiliares
        function calcularPrioridad(tipoAlerta) {
            const prioridades = {
                'emergencia': 5,
                'zona_peligrosa': 4,
                'trafico': 3,
                'informativa': 1
            };
            return prioridades[tipoAlerta] || 1;
        }

        function getTipoIncidenteNombre(tipo) {
            const nombres = {
                'congestion': 'Congestión',
                'accident': 'Accidente',
                'road_closure': 'Cierre de Vía',
                'construction': 'Construcción'
            };
            return nombres[tipo] || tipo;
        }

        function simularNotificacionesPorUbicacion(alerta) {
            // Simular usuarios en el área
            const usuariosEnArea = [1, 2, 3]; // IDs de usuarios simulados
            
            usuariosEnArea.forEach(usuarioId => {
                const notificacion = {
                    id: Date.now() + usuarioId,
                    usuario_id: usuarioId,
                    titulo: alerta.titulo,
                    mensaje: alerta.mensaje,
                    tipo: 'alerta_ubicacion',
                    fecha_envio: new Date().toISOString(),
                    es_leida: false,
                    prioridad: alerta.prioridad
                };
                
                notificacionesSimuladas.push(notificacion);
            });
        }

        function simularNotificacionesMasivas(alerta) {
            // Simular envío masivo
            const todosUsuarios = [1, 2, 3, 4, 5]; // IDs de usuarios simulados
            
            todosUsuarios.forEach(usuarioId => {
                const notificacion = {
                    id: Date.now() + usuarioId,
                    usuario_id: usuarioId,
                    titulo: alerta.titulo,
                    mensaje: alerta.mensaje,
                    tipo: 'alerta_general',
                    fecha_envio: new Date().toISOString(),
                    es_leida: false,
                    prioridad: alerta.prioridad
                };
                
                notificacionesSimuladas.push(notificacion);
            });
        }

        function mostrarResultado(elementId, tipo, mensaje) {
            const elemento = document.getElementById(elementId);
            elemento.className = `result ${tipo}`;
            elemento.textContent = mensaje;
            elemento.style.display = 'block';
            
            setTimeout(() => {
                elemento.style.display = 'none';
            }, 5000);
        }

        // Inicializar con algunas notificaciones de ejemplo
        document.addEventListener('DOMContentLoaded', function() {
            notificacionesSimuladas = [
                {
                    id: 1001,
                    usuario_id: 1,
                    titulo: 'Bienvenido al Sistema',
                    mensaje: 'Su cuenta ha sido configurada correctamente.',
                    tipo: 'informativa',
                    fecha_envio: new Date(Date.now() - 3600000).toISOString(),
                    es_leida: false,
                    prioridad: 1
                },
                {
                    id: 1002,
                    usuario_id: 1,
                    titulo: 'Mantenimiento Programado',
                    mensaje: 'Habrá mantenimiento en la Av. Bolognesi mañana de 9-11 AM.',
                    tipo: 'informativa',
                    fecha_envio: new Date(Date.now() - 1800000).toISOString(),
                    es_leida: false,
                    prioridad: 2
                }
            ];
        });
    </script>
</body>
</html>