{% comment %} <title>{% block title %}My App{% endblock %}</title>
{% endcomment %}
<title>Registro | Traffic Pulse</title>

<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
  crossorigin="anonymous" />
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
{% load static %}

<div class="container-fluid m-0 row bg-primary" style="min-height: 100%">
  <main class="form-signin row col-md-6 py-4 m-auto bg-white rounded">
    <div class="container-fluid col col-md-6">
      <img
        src="{% static 'images/user-icon.webp' %}"
        class="img-fluid w-100 mx-auto d-block mb-4"
        style="max-width: 200px"
        alt="user-icon" />
      <h4 class="text-center mb-4 text-muted">Bienvenido, crea tu cuenta</h4>
    </div>
    <form method="post" id="registro-form" novalidate>
      {% csrf_token %}

      <div class="form-floating mb-3">
        {{ form.username }}
        <label for="username">Usuario</label>
        {% if form.username.errors %}
        <div class="invalid-feedback d-block">{{ form.username.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="form-floating mb-3">
        {{ form.email }}
        <label for="email">Correo electrónico</label>
        {% if form.email.errors %}
        <div class="invalid-feedback d-block">{{ form.email.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="position-relative mb-3">
        <div class="form-floating position-relative col-11 d-flex w-100">
          {{ form.password1 }}
          <label for="password1">Contraseña</label>
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm toggle-password col-1 border-secondary-subtle">
            <i class="bi bi-eye toggle-icon"></i>
          </button>
        </div>
        {% if form.password1.errors %}
        <div class="invalid-feedback d-block">
          {{ form.password1.errors.0 }}
        </div>
        {% endif %}
      </div>

      <div class="position-relative mb-3">
        <div class="form-floating position-relative col-11 d-flex w-100">
          {{ form.password2 }}
          <label for="password2">Confirmar Contraseña</label>
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm toggle-password col-1 border-secondary-subtle">
            <i class="bi bi-eye toggle-icon"></i>
          </button>
        </div>
        {% if form.password2.errors %}
        <div class="invalid-feedback d-block">
          {{ form.password2.errors.0 }}
        </div>
        {% endif %}
      </div>

      <p class="text-muted text-end pe-4" style="font-size: 0.8em">
        ¿Ya tienes una cuenta?
        <a href="{% url 'login' %}" class="link-offset-1-hover"
          >Iniciar Sesión</a
        >
      </p>

      <div class="d-flex justify-content-end pe-4">
        <button type="submit" class="btn btn-secondary">Crear cuenta</button>
      </div>
    </form>
  </main>
</div>
<script>
  const form = document.getElementById("registro-form");
  const username = document.getElementById("username");
  const emailInput = document.getElementById("email");
  const password1 = document.getElementById("password1");
  const password2 = document.getElementById("password2");

  const passwordFields = document.querySelectorAll(".password-input");
  const toggleButtons = document.querySelectorAll(".toggle-password");

  toggleButtons.forEach((button, index) => {
    const icon = button.querySelector(".toggle-icon");
    const input = passwordFields[index];

    button.addEventListener("click", () => {
      const type =
        input.getAttribute("type") === "password" ? "text" : "password";
      input.setAttribute("type", type);
      icon.classList.toggle("bi-eye");
      icon.classList.toggle("bi-eye-slash");
    });
  });

  form.addEventListener("submit", function (e) {
    let valid = true;

    [username, emailInput, password1, password2].forEach((input) => {
      input.classList.remove("is-invalid");
    });

    if (username.value.trim() === "") {
      username.classList.add("is-invalid");
      valid = false;
    }

    const emailValue = emailInput.value.trim();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    if (emailValue === "" || !emailRegex.test(emailValue)) {
      emailInput.classList.add("is-invalid");
      valid = false;
    }

    if (password1.value.length < 6) {
      password1.parentElement.classList.add("is-invalid");
      valid = false;
    }

    if (password1.value !== password2.value) {
      password2.parentElement.classList.add("is-invalid");
      valid = false;
    }

    if (!valid) {
      e.preventDefault();
    }
  });
</script>
